<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- 기존 head 내용 유지 -->
</head>
<body>
<!-- 기존 body 내용 유지 -->

<script th:inline="javascript">
    let chatId = Date.now().toString();

    function appendMessage(sender, message, isUser = false) {
        // 기존 코드 유지
    }

    function sendMessage() {
        let message = $('#user-input').val();
        if (message.trim() === '') return;

        appendMessage('You', message, true);
        $('#user-input').val('');

        let aiResponse = '';
        appendMessage('AI', '');

        const eventSource = new EventSource('/stream?message=' + encodeURIComponent(message) + '&chatId=' + chatId);

        eventSource.onmessage = function(event) {
            aiResponse += event.data;
            $('.message-ai:last span').text(aiResponse);
            $('#chat-messages').scrollTop($('#chat-messages')[0].scrollHeight);
        };

        eventSource.onerror = function(error) {
            eventSource.close();
            if (aiResponse === '') {
                appendMessage('Error', 'Failed to get response');
            }
        };

        eventSource.addEventListener('complete', function(event) {
            eventSource.close();
        }, false);
    }

    // Enter key to send message
    $('#user-input').keypress(function(e) {
        if (e.which == 13) {
            sendMessage();
            return false;
        }
    });
</script>
</body>
</html>